<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>PA2 on Wenbo&#39;s Study Notes</title>
    <link>http://localhost:1313/notes/docs/cs/ysyx/nemu/pa2/</link>
    <description>Recent content in PA2 on Wenbo&#39;s Study Notes</description>
    <generator>Hugo</generator>
    <language>ch</language>
    <atom:link href="http://localhost:1313/notes/docs/cs/ysyx/nemu/pa2/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title></title>
      <link>http://localhost:1313/notes/docs/cs/ysyx/nemu/pa2/trace/</link>
      <pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate>
      <guid>http://localhost:1313/notes/docs/cs/ysyx/nemu/pa2/trace/</guid>
      <description>&lt;h1 id=&#34;1-配置菜单&#34;&gt;&#xD;&#xA;  1. 配置菜单&#xD;&#xA;  &lt;a class=&#34;anchor&#34; href=&#34;#1-%e9%85%8d%e7%bd%ae%e8%8f%9c%e5%8d%95&#34;&gt;#&lt;/a&gt;&#xD;&#xA;&lt;/h1&gt;&#xD;&#xA;&lt;p&gt;查看 &lt;code&gt;$NEMU_HOME/Kconfig&lt;/code&gt;文件，检查 &lt;em&gt;TRACE&lt;/em&gt; 相关宏：&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-c&#34; data-lang=&#34;c&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;config TRACE&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#66d9ef&#34;&gt;bool&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Enable tracer&amp;#34;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#66d9ef&#34;&gt;default&lt;/span&gt; y&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;...&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;config ITRACE&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  depends on TRACE &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; TARGET_NATIVE_ELF &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; ENGINE_INTERPRETER&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#66d9ef&#34;&gt;bool&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Enable instruction tracer&amp;#34;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#66d9ef&#34;&gt;default&lt;/span&gt; y&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;config ITRACE_COND&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  depends on ITRACE&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  string &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Only trace instructions when the condition is true&amp;#34;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#66d9ef&#34;&gt;default&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;true&amp;#34;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在配置菜单了相关选项后，会在 &lt;code&gt;$NEMU_HOME/.config&lt;/code&gt; 中生成相应的配置。例如, 在配置菜单中&lt;code&gt; [y] TRACE&lt;/code&gt;，就会在该文件中生成 &lt;code&gt;CONFIG_ITRACE=y&lt;/code&gt; ，最终会生成一个&lt;code&gt;$NEME_HOME/include/generated/autoconf.h&lt;/code&gt; 头文件，其中包括 &lt;code&gt;#define CONFIG_TRACE y&lt;/code&gt;，而这个头文件在 &lt;code&gt;common.h&lt;/code&gt; 中被引用。&lt;/p&gt;&#xA;&lt;h1 id=&#34;2关于trace的宏依赖&#34;&gt;&#xD;&#xA;  2.关于TRACE的宏依赖&#xD;&#xA;  &lt;a class=&#34;anchor&#34; href=&#34;#2%e5%85%b3%e4%ba%8etrace%e7%9a%84%e5%ae%8f%e4%be%9d%e8%b5%96&#34;&gt;#&lt;/a&gt;&#xD;&#xA;&lt;/h1&gt;&#xD;&#xA;&lt;hr&gt;&#xA;&lt;p&gt;如果要通过配置菜单来配置 &lt;em&gt;TRACE&lt;/em&gt; 相关的宏，会存在一个依赖链：&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;CONFIG_TRACE            CONFIG_TARGET_NATIVE_ELF            CONFIG_ENGINE_INTERPRETER&#xD;&#xA;      \                         |                                   /&#xD;&#xA;       \                        |                                  /&#xD;&#xA;        +-----------------------+---------------------------------+&#xD;&#xA;                                |&#xD;&#xA;                          +---------------+&#xD;&#xA;                          | CONFIG_ITRACE |&#xD;&#xA;                          +---------------+&#xD;&#xA;                                |&#xD;&#xA;                       +-------------------+&#xD;&#xA;                       | CONFIG_ITRACE_COND |&#xD;&#xA;                        +-------------------+&#xD;&#xA;                                |&#xD;&#xA;                           +-------------+&#xD;&#xA;                           | ITRACE_COND |&#xD;&#xA;                           +-------------+&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;前三行是通过配置菜单生成的，而最后一行是通过 &lt;code&gt;$NEMU_HOME/Makefile&lt;/code&gt; 生成的，具体如下：&lt;/p&gt;</description>
    </item>
    <item>
      <title></title>
      <link>http://localhost:1313/notes/docs/cs/ysyx/nemu/pa2/%E5%88%A4%E6%96%ADcall%E4%B8%8Eret/</link>
      <pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate>
      <guid>http://localhost:1313/notes/docs/cs/ysyx/nemu/pa2/%E5%88%A4%E6%96%ADcall%E4%B8%8Eret/</guid>
      <description>&lt;p&gt;对于 &lt;em&gt;riscv32&lt;/em&gt; 指令集来说：&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;code&gt;jal&lt;/code&gt;可以用于近距离函数调用（距离当前pc不超过 &lt;em&gt;±1MB&lt;/em&gt; 的函数）；&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;jalr&lt;/code&gt; 可以用于函数返回以及远距离函数调用&lt;/li&gt;&#xA;&lt;li&gt;但是，&lt;strong&gt;这两条指令并不一定用于函数返回和调用&lt;/strong&gt;。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;因此，需要找出：&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;code&gt;jal&lt;/code&gt; 什么时候用于函数调用&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;jalr&lt;/code&gt; 什么时候用于函数调用&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;jalr&lt;/code&gt; 什么时候用于函数返回&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;为了保证正确性，以及维护调用栈，可以使用一个栈来记录未返回的函数以及其返回地址。&lt;/p&gt;&#xA;&lt;p&gt;用如下数据结构作为调用栈：&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-c&#34; data-lang=&#34;c&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;typedef&lt;/span&gt; {&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#66d9ef&#34;&gt;size_t&lt;/span&gt; idx&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#66d9ef&#34;&gt;uint32_t&lt;/span&gt; ret_addr&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;} ret_stk_e;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;ret_stk[&lt;span style=&#34;color:#ae81ff&#34;&gt;30&lt;/span&gt;];&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h1 id=&#34;1-jaljalr-用于函数调用&#34;&gt;&#xD;&#xA;  1. &lt;code&gt;jal&lt;/code&gt;，jalr 用于函数调用&#xD;&#xA;  &lt;a class=&#34;anchor&#34; href=&#34;#1-jaljalr-%e7%94%a8%e4%ba%8e%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8&#34;&gt;#&lt;/a&gt;&#xD;&#xA;&lt;/h1&gt;&#xD;&#xA;&lt;hr&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;跳转到一个函数首地址&lt;/li&gt;&#xA;&lt;li&gt;使用 &lt;code&gt;$ra&lt;/code&gt; 存放 &lt;code&gt;PC + 4&lt;/code&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;h1 id=&#34;1-jalr-用于返回&#34;&gt;&#xD;&#xA;  1. jalr 用于返回&#xD;&#xA;  &lt;a class=&#34;anchor&#34; href=&#34;#1-jalr-%e7%94%a8%e4%ba%8e%e8%bf%94%e5%9b%9e&#34;&gt;#&lt;/a&gt;&#xD;&#xA;&lt;/h1&gt;&#xD;&#xA;&lt;p&gt;栈顶未返回的函数的返回地址应该与 &lt;code&gt;jalr&lt;/code&gt; 跳转的目的地址相同。&lt;/p&gt;</description>
    </item>
  </channel>
</rss>
