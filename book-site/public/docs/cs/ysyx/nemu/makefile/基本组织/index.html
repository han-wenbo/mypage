<!DOCTYPE html>
<html lang="ch" dir="ltr">
<head><script src="/notes/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=notes/livereload" data-no-instant defer></script>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="
  基本组织
  #


  1.项目目录下的Makefile文件结构
  #

. 为nemu根目录，在nume项目根目录下，可以看到有很多makefile文件：
nemu
|── Makefile
├── scripts
│   ├── build.mk
│   ├── config.mk
│   └── native.mk
├── src
    ├── filelist.mk
    ├── device
    │   └── filelist.mk
    ├── engine
    │   └── filelist.mk
    ├── filelist.mk
    ├── isa
    │   └── filelist.mk
    └── utils
        └── filelist.mk


项目根目录下的Makefile 文件并没有实际的目标定义，而是一系列的变量与 include语句，将其他makefile文件包含进来。 其中一个非常重要的变量为 SRCS , 这个变量收集了所有要参与编译的 .c 文件。


nemu/src/.. 目录下的 filelist.mk 主要做了三件事情：">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="http://localhost:1313/notes/docs/cs/ysyx/nemu/makefile/%E5%9F%BA%E6%9C%AC%E7%BB%84%E7%BB%87/">
  <meta property="og:site_name" content="Wenbo&#39;s Study Notes">
  <meta property="og:title" content="Wenbo&#39;s Study Notes">
  <meta property="og:description" content="基本组织 # 1.项目目录下的Makefile文件结构 # . 为nemu根目录，在nume项目根目录下，可以看到有很多makefile文件：
nemu |── Makefile ├── scripts │ ├── build.mk │ ├── config.mk │ └── native.mk ├── src ├── filelist.mk ├── device │ └── filelist.mk ├── engine │ └── filelist.mk ├── filelist.mk ├── isa │ └── filelist.mk └── utils └── filelist.mk 项目根目录下的Makefile 文件并没有实际的目标定义，而是一系列的变量与 include语句，将其他makefile文件包含进来。 其中一个非常重要的变量为 SRCS , 这个变量收集了所有要参与编译的 .c 文件。
nemu/src/.. 目录下的 filelist.mk 主要做了三件事情：">
  <meta property="og:locale" content="ch">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
<title>基本组织 | Wenbo&#39;s Study Notes</title>
<link rel="icon" href="/notes/favicon.png" >
<link rel="manifest" href="/notes/manifest.json">
<link rel="canonical" href="http://localhost:1313/notes/docs/cs/ysyx/nemu/makefile/%E5%9F%BA%E6%9C%AC%E7%BB%84%E7%BB%87/">
<link rel="stylesheet" href="/notes/book.min.7bc972065ba8380494d6074bd191d8bf416964b6d9b4911d35dd0bf0f8e914e5.css" integrity="sha256-e8lyBluoOASU1gdL0ZHYv0FpZLbZtJEdNd0L8PjpFOU=" crossorigin="anonymous">
  <script defer src="/notes/fuse.min.js"></script>
  <script defer src="/notes/ch.search.min.1b4552d846c5a695ecdeac6b05225a3f84bee4adb21c9a1d4b84193c6a708334.js" integrity="sha256-G0VS2EbFppXs3qxrBSJaP4S&#43;5K2yHJodS4QZPGpwgzQ=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/notes/"><span>Wenbo&#39;s Study Notes</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="" aria-label="" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>



  



  
    
  



<ul class="book-languages">
  <li>
    <input type="checkbox" id="languages" class="toggle" />
    <label for="languages" class="flex justify-between">
      <a role="button" class="flex align-center">
        <img src="/notes/svg/translate.svg" class="book-icon" alt="Languages" />
        中文
      </a>
    </label>

    <ul>
      
      <li>
        <a href="/notes/en/">
          English
        </a>
      </li>
      
    </ul>
  </li>
</ul>














  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-20535e814cb0e9fbc418302e148287db" class="toggle"  />
    <label for="section-20535e814cb0e9fbc418302e148287db" class="flex justify-between">
      <a role="button" class="">数学</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-a8afdc623c7f05ddd9d3323a5f24ab17" class="toggle" checked />
    <label for="section-a8afdc623c7f05ddd9d3323a5f24ab17" class="flex justify-between">
      <a role="button" class="">计算机</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-002438c68499130bd3a4d57e8ce70429" class="toggle"  />
    <label for="section-002438c68499130bd3a4d57e8ce70429" class="flex justify-between">
      <a role="button" class="">C programing Language</a>
    </label>
  

          
  <ul>
    
      
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/cs/c-progaming-language/%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0%E8%B7%A8%E5%B9%B3%E5%8F%B0/" class="">可变参数跨的平台</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-bbe8481416d37ff148d90e1b55aa9455" class="toggle"  />
    <label for="section-bbe8481416d37ff148d90e1b55aa9455" class="flex justify-between">
      <a role="button" class="">Linux系统编程</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/cs/linuxsysprograming/3rd-level/" class="">3rd Level</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/cs/linuxsysprograming/3rd-level/4th-level/" class="">4th Level</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-41373c7ccc5f2851e1dd9b049a0b0eb3" class="toggle" checked />
    <label for="section-41373c7ccc5f2851e1dd9b049a0b0eb3" class="flex justify-between">
      <a role="button" class="">YSYX</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-6eb6b4496591e877deb7041468b14c5d" class="toggle"  />
    <label for="section-6eb6b4496591e877deb7041468b14c5d" class="flex justify-between">
      <a role="button" class="">Ahstarct-machine</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-c0759843681831b9d7c760608a706361" class="toggle"  />
    <label for="section-c0759843681831b9d7c760608a706361" class="flex justify-between">
      <a href="/notes/docs/cs/ysyx/ahstarct-machine/makefile/" class="">Makefile</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/cs/ysyx/ahstarct-machine/makefile/%E8%B7%9F%E8%B8%AAmake%E5%91%BD%E4%BB%A4/" class="">跟踪make命令</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/cs/ysyx/ahstarct-machine/makefile/%E9%98%85%E8%AF%BB%E6%BA%90%E7%A0%81/" class="">阅读源码</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-78400b319b513445b7fd190a472208f1" class="toggle" checked />
    <label for="section-78400b319b513445b7fd190a472208f1" class="flex justify-between">
      <a role="button" class="">NEMU</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b1a01d85a9e747d7b4511f34f2d46cd7" class="toggle" checked />
    <label for="section-b1a01d85a9e747d7b4511f34f2d46cd7" class="flex justify-between">
      <a href="/notes/docs/cs/ysyx/nemu/makefile/" class="">Makefile</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/cs/ysyx/nemu/makefile/%E5%9F%BA%E6%9C%AC%E7%BB%84%E7%BB%87/" class="active">基本组织</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b03eed1fe077c2734a3a82f668e3ae54" class="toggle"  />
    <label for="section-b03eed1fe077c2734a3a82f668e3ae54" class="flex justify-between">
      <a role="button" class="">自动机理论</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/cs/automaton/%E4%B8%8A%E6%8E%A8%E8%87%AA%E5%8A%A8%E6%9C%BA/out/" class="">Out</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-98f1713060afc41e5bbfe772a1ea1b60" class="toggle"  />
    <label for="section-98f1713060afc41e5bbfe772a1ea1b60" class="flex justify-between">
      <a role="button" class="">计算机体系结构</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/cs/arch/3rd-level/" class="">3rd Level</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/cs/arch/3rd-level/4th-level/" class="">4th Level</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-4e09593fbba0e2dab0f3a45006960669" class="toggle"  />
    <label for="section-4e09593fbba0e2dab0f3a45006960669" class="flex justify-between">
      <a role="button" class="">重读CSAPP</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-3c0400cb5a64f18f82be5ada6a36a304" class="toggle"  />
    <label for="section-3c0400cb5a64f18f82be5ada6a36a304" class="flex justify-between">
      <a href="/notes/docs/cs/csapp/chapter2/" class="">第二章</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/cs/csapp/chapter2/%E8%AF%81%E6%98%8E%E6%97%A0%E7%AC%A6%E5%8F%B7%E6%95%B0%E5%92%8C%E8%A1%A5%E7%A0%81%E5%8A%A0%E6%B3%95%E4%BD%8D%E7%BA%A7%E8%A1%A8%E7%A4%BA%E4%B8%80%E6%A0%B7/" class="">证明：无符号数和补码加法位级表示一样</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/cs/csapp/chapter2/%E6%97%A0%E7%AC%A6%E5%8F%B7%E6%95%B0%E4%B8%8E%E8%A1%A5%E7%A0%81%E5%8A%A0%E6%B3%95%E7%A1%AC%E4%BB%B6%E5%AE%9E%E7%8E%B0/" class="">无符号数与补码加法硬件实现</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/cs/csapp/chapter2/%E6%97%A0%E7%AC%A6%E5%8F%B7%E6%95%B0%E5%87%8F%E6%B3%95%E7%9A%84%E5%AE%9A%E4%B9%89/" class="">无符号数减法的定义</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/cs/csapp/chapter2/%E8%A1%A5%E7%A0%81%E5%87%8F%E6%B3%95%E7%9A%84%E5%AE%9A%E4%B9%89/" class="">补码减法的定义</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/cs/csapp/chapter2/%E5%8A%A0%E6%B3%95%E9%80%86%E5%85%83%E7%9A%84%E4%BD%8D%E5%90%91%E9%87%8F/" class="">加法逆元的位向量</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/cs/csapp/chapter2/0%E6%89%A9%E5%B1%95%E7%9A%84%E5%8A%A0%E6%B3%95/" class="">0扩展的加法</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/cs/csapp/chapter2/cpp%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E9%99%B7%E9%98%B1/" class="">Cpp类型转换陷阱</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/cs/csapp/chapter2/c%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E9%99%B7%E9%98%B1%E9%99%A4%E6%B3%95/" class="">C类型转换陷阱：除法</a>
  

        </li>
      
    
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-3dc0332fdce4a710073932a6e679f19b" class="toggle"  />
    <label for="section-3dc0332fdce4a710073932a6e679f19b" class="flex justify-between">
      <a role="button" class="">Hugo</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/hugo/%E5%8E%BB%E6%8E%89%E5%BA%95%E9%83%A8%E5%B9%BF%E5%91%8A/" class="">去掉Hugo Blox模板底部广告</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/hugo/%E6%88%91%E7%9A%84%E5%8D%9A%E5%AE%A2%E6%98%AF%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BA%E7%9A%84/" class="">我的Page是如何搭建的</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-c37cf45590308ffd8c7e52fb18385ee5" class="toggle"  />
    <label for="section-c37cf45590308ffd8c7e52fb18385ee5" class="flex justify-between">
      <a role="button" class="">Shortcodes</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/shortcodes/buttons/" class="">Buttons</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/shortcodes/columns/" class="">Columns</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/shortcodes/details/" class="">Details</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/shortcodes/hints/" class="">Hints</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/shortcodes/mermaid/" class="">Mermaid</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/shortcodes/tabs/" class="">Tabs</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/notes/docs/shortcodes/katex/" class="">KaTeX</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>














</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/notes/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>基本组织</h3>

  <label for="toc-control">
    
    <img src="/notes/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#1项目目录下的makefile文件结构">1.项目目录下的Makefile文件结构</a></li>
    <li><a href="#2-从-make-run-的角度打开-makefile">2. 从 make run 的角度打开 Makefile</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="基本组织">
  基本组织
  <a class="anchor" href="#%e5%9f%ba%e6%9c%ac%e7%bb%84%e7%bb%87">#</a>
</h1>
<h2 id="1项目目录下的makefile文件结构">
  1.项目目录下的Makefile文件结构
  <a class="anchor" href="#1%e9%a1%b9%e7%9b%ae%e7%9b%ae%e5%bd%95%e4%b8%8b%e7%9a%84makefile%e6%96%87%e4%bb%b6%e7%bb%93%e6%9e%84">#</a>
</h2>
<p><code>.</code> 为nemu根目录，在nume项目根目录下，可以看到有很多makefile文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>nemu
</span></span><span style="display:flex;"><span>|── Makefile
</span></span><span style="display:flex;"><span>├── scripts
</span></span><span style="display:flex;"><span>│   ├── build.mk
</span></span><span style="display:flex;"><span>│   ├── config.mk
</span></span><span style="display:flex;"><span>│   └── native.mk
</span></span><span style="display:flex;"><span>├── src
</span></span><span style="display:flex;"><span>    ├── filelist.mk
</span></span><span style="display:flex;"><span>    ├── device
</span></span><span style="display:flex;"><span>    │   └── filelist.mk
</span></span><span style="display:flex;"><span>    ├── engine
</span></span><span style="display:flex;"><span>    │   └── filelist.mk
</span></span><span style="display:flex;"><span>    ├── filelist.mk
</span></span><span style="display:flex;"><span>    ├── isa
</span></span><span style="display:flex;"><span>    │   └── filelist.mk
</span></span><span style="display:flex;"><span>    └── utils
</span></span><span style="display:flex;"><span>        └── filelist.mk
</span></span></code></pre></div><ul>
<li>
<p>项目根目录下的<code>Makefile</code> 文件并没有实际的目标定义，而是一系列的变量与 include语句，将其他makefile文件包含进来。 其中一个非常重要的变量为 <code>SRCS</code> , 这个变量收集了所有要参与编译的 <code>.c</code> 文件。</p>
</li>
<li>
<p><code>nemu/src/..</code> 目录下的 <code>filelist.mk</code> 主要做了三件事情：</p>
<ul>
<li>给<code>SRCS-y</code>变量追加单个的<code>.c</code>文件名，</li>
<li>给<code>DIRS-y</code> 追加搜索 <code>.c</code> 文件的目录，</li>
<li>添加<code>.c</code>文件黑名单。</li>
</ul>
</li>
<li>
<p><code>scripts</code> 目录下的 makefile 文件定义编译用的目标与各种依赖。其中：</p>
<ul>
<li><code>native.mk</code> 主要定义了使用最频繁的<code>run</code> 目标。</li>
<li><code>build.mk</code>  主要定义了一个 <code>.c</code> 文件如何编译成 <code>.o</code>文件的目标，以及如何将这些<code>.o</code>链接成nemu可执行文件。</li>
</ul>
</li>
</ul>
<h2 id="2-从-make-run-的角度打开-makefile">
  2. 从 make run 的角度打开 Makefile
  <a class="anchor" href="#2-%e4%bb%8e-make-run-%e7%9a%84%e8%a7%92%e5%ba%a6%e6%89%93%e5%bc%80-makefile">#</a>
</h2>
<p>先简单看一下 <code>make run</code> 的定义：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-makefile" data-lang="makefile"><span style="display:flex;"><span> -----------------nume/scrpits/native.mk-------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">...</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">compile_git</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">$(</span>call git_commit, <span style="color:#e6db74">&#34;compile NEMU&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$(BINARY)</span><span style="color:#f92672">::</span> compile_git
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">run-env</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">$(</span>BINARY<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>DIFF_REF_SO<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>NEMU_EXEC <span style="color:#f92672">:=</span> <span style="color:#66d9ef">$(</span>BINARY<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>ARGS<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>IMG<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">run</span><span style="color:#f92672">:</span> run-env
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">$(</span>call git_commit, <span style="color:#e6db74">&#34;run NEMU&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">$(</span>NEMU_EXEC<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>        
</span></span></code></pre></div><p>可以通过变量名字猜测出<code> $(NEMU_EXEC)</code>或者说<code>$(BINARY) $(ARGS) $(IMG)</code> 的作用就是执行实际的 nemu 程序，并给定相应的参数，以及要读入的二进制文件。而 <code>run</code> 和 <code>run-env</code> 都是伪目标，因此当运行 <code>make run</code> 时，目标 <code>run-env</code> 一定会被执行一次。</p>
<p>现在来关注一下<code>$(BINARY)</code> ， 这不仅是一个变量，而且还用这个变量定义了两个目标，注意定义目标时用的是双引号<code>$(BINARY)::..</code>，这被称为 <em>Double-colon rules</em> ，意味着可以有多个同名的目标，每次执行该目标时，会检测每个有这个名字的目标的依赖，来判断是否执行该目标。</p>
<p><code>$(BINARY)</code> 变量以及另外一个名为<code>$(BINARY)</code> 的目标被定义在 <code> scripts/build.mk</code> 中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-makefile" data-lang="makefile"><span style="display:flex;"><span> -----------------nume/scrpits/build.mk-------------------
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">...</span>
</span></span><span style="display:flex;"><span>SO <span style="color:#f92672">=</span> -so
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>WORK_DIR  <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>shell pwd<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>BUILD_DIR <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>WORK_DIR<span style="color:#66d9ef">)</span>/build
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>INC_PATH <span style="color:#f92672">:=</span> <span style="color:#66d9ef">$(</span>WORK_DIR<span style="color:#66d9ef">)</span>/include <span style="color:#66d9ef">$(</span>INC_PATH<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>OBJ_DIR  <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>BUILD_DIR<span style="color:#66d9ef">)</span>/obj-<span style="color:#66d9ef">$(</span>NAME<span style="color:#66d9ef">)$(</span>SO<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>BINARY   <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>BUILD_DIR<span style="color:#66d9ef">)</span>/<span style="color:#66d9ef">$(</span>NAME<span style="color:#66d9ef">)$(</span>SO<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OBJS <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>SRCS:%.c<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>OBJ_DIR<span style="color:#66d9ef">)</span>/%.o<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>CXXSRC:%.cc<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>OBJ_DIR<span style="color:#66d9ef">)</span>/%.o<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$(BINARY)</span><span style="color:#f92672">::</span> <span style="color:#66d9ef">$(</span>OBJS<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>ARCHIVES<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>        @echo + LD $@
</span></span><span style="display:flex;"><span>        @<span style="color:#66d9ef">$(</span>LD<span style="color:#66d9ef">)</span> -o $@ <span style="color:#66d9ef">$(</span>OBJS<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>LDFLAGS<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>ARCHIVES<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>LIBS<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$(OBJ_DIR)/%.o</span><span style="color:#f92672">:</span> %.cc
</span></span><span style="display:flex;"><span>        @echo + CXX $&lt;
</span></span><span style="display:flex;"><span>        @mkdir -p <span style="color:#66d9ef">$(</span>dir $@<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>        @<span style="color:#66d9ef">$(</span>CXX<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>CFLAGS<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>CXXFLAGS<span style="color:#66d9ef">)</span> -c -o $@ $&lt;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">$(</span>call call_fixdep, <span style="color:#66d9ef">$(</span>@:.o<span style="color:#f92672">=</span>.d<span style="color:#66d9ef">)</span>, $@<span style="color:#66d9ef">)</span>
</span></span></code></pre></div><p><strong>将变量和目标同名，再将这个目标作为依赖</strong> 是一种很方便且常见的用法，出现在目标和依赖中的变量会被展开为该变量的字符串。因此，执行命令 <code>make run</code>，会执行伪目标 <code>run-env</code>，而这个目标依赖 <code>$(BINARY)</code>， <code>$(BINARY)</code>有两个定义，其中非常重要的一个规则是 <code>$(BINARY):: $(OBJS) $(ARCHIVES)</code> ，它将<code>$(OBJ)</code> 中的<code>.o</code> 文件链接在一起，生成nume可执行文件。Makefile会根据<code>$(OBJS)</code>中文件的新旧或<code>$(BINARY)</code>是否存在来判断是否执行该规则。</p>
<p><code>OBJ</code> 变量将 <code>SRCS</code> 变量中的每一个  <code>.c</code> 文件名后缀替换成 <code>.o</code> ，再在该文件名前面添<code>OBJ_DIR</code>变量的字符串而来。 <code>SRCS</code>定义在 <code>neme/Makefile</code> 中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-makefile" data-lang="makefile"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">--------------------------------nemu/Makefile--------------------------------------</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">....</span>
</span></span><span style="display:flex;"><span>FILELIST_MK <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>shell find -L ./src -name <span style="color:#e6db74">&#34;filelist.mk&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">include</span> <span style="color:#66d9ef">$(</span>FILELIST_MK<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Filter out directories and files in blacklist to obtain the final set of source files
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>DIRS-BLACKLIST-y <span style="color:#f92672">+=</span> <span style="color:#66d9ef">$(</span>DIRS-BLACKLIST<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>SRCS-BLACKLIST-y <span style="color:#f92672">+=</span> <span style="color:#66d9ef">$(</span>SRCS-BLACKLIST<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>shell find -L <span style="color:#66d9ef">$(</span>DIRS-BLACKLIST-y<span style="color:#66d9ef">)</span> -name <span style="color:#e6db74">&#34;*.c&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>SRCS-y <span style="color:#f92672">+=</span> <span style="color:#66d9ef">$(</span>shell find -L <span style="color:#66d9ef">$(</span>DIRS-y<span style="color:#66d9ef">)</span> -name <span style="color:#e6db74">&#34;*.c&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>SRCS <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>filter-out <span style="color:#66d9ef">$(</span>SRCS-BLACKLIST-y<span style="color:#66d9ef">)</span>,<span style="color:#66d9ef">$(</span>SRCS-y<span style="color:#66d9ef">))</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">....</span>
</span></span></code></pre></div><p><code>SRCS</code> 变量根据<code>SRCS-BLACKLIST-y</code> 筛选 <code>SRCS-y</code> 变量，而一些目录下的<code>filelist.mk</code> 会给变量<code>SRCS-y</code> 和<code>DIR-y</code>追加一些内容，例如 <code>nemu/src/filelist.mk</code>的<code>SRCS-y</code> 追加了 <code>nemu-main.c</code> ， <code>DIRS-y</code> 追加了三个目录。</p>
<p>而<code>nemu/Makefile</code>会 inlcude 所有的 <code>filelist.mk</code> 文件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-makefile" data-lang="makefile"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">--------------------------------nemu/src/filelist.mk--------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">..</span>
</span></span><span style="display:flex;"><span>SRCS-y <span style="color:#f92672">+=</span> src/nemu-main.c
</span></span><span style="display:flex;"><span>DIRS-y <span style="color:#f92672">+=</span> src/cpu src/monitor src/utils
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">...</span>
</span></span></code></pre></div><p>如果想在 <code>src</code> 中新建一个目录，并且将这里面的源文件参与链接，我们可以在 <code>DIRS-y</code> 添加一个新的目录，例如 <code>src/new-dir</code>。</p>
<p>到现在为止，已经知道了nemu的makefile是如何收集以及收集哪些 <code>.c</code> 文件来编译，哪些 <code>.o</code> 来参与链接的了。</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#1项目目录下的makefile文件结构">1.项目目录下的Makefile文件结构</a></li>
    <li><a href="#2-从-make-run-的角度打开-makefile">2. 从 make run 的角度打开 Makefile</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












