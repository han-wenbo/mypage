# 0.

---

深入理解计算机系统第八章围绕着 **异常控制流（Exceptional control flow）** 讲解了一系列概念，在此做一个简单的总结 。

假设处理器从上电到断电为止，其 **程序计数器** 是一个非负整数的序列：{{<katex>}}a_0,...a_{n-1} {{</katex>}}，其中 {{<katex>}} a_i {{</katex>}}是指令 {{<katex>}} I_i {{</katex>}} 的地址。

**控制转移（control transfer）：** 程序计数器的状态从 {{<katex>}}a_i {{</katex>}} 到 {{<katex>}}a_{i+1} {{</katex>}} 的变化。因此，一次控制转移可以定义为一个二元组 {{<katex>}}(x,y) {{</katex>}}，其中，若{{<katex>}}x = a_i {{</katex>}} ，则 {{<katex>}}y = a_{i+1} {{</katex>}}，反之也成立。

**控制流（control flow）**： 一个由控制转移构成的 **序列（sequence）**，这可以从元组的序列退化为非负整数的序列。

{{% hint danger %}}  设指令 {{<katex>}}I_i {{</katex>}} 的长度为 {{<katex>}}L {{</katex>}}，若 {{<katex>}}a_i + L = a_{i+1}{{</katex>}} ，则称 {{<katex>}}I_i , I_{i+1}{{</katex>}} 在内存中相邻。
{{% /hint %}}

{{% hint danger %}}  

对于一个控制流，若其每个控制转移对应的指令都是相邻的，那么称这个控制流是平滑的。若存在至少一个控制转移的对应的指令不是相邻的，那这个控制流被称为是非平滑的。

{{% /hint %}}

**造成非平滑的控制流主要原因有两种**：

- 一个程序中的过程调用、返回、分支结构；
- **对整个计算机系统的状态变化做出反应**，这种情况的控制流称为 **异常控制流 (Exceptional control flow)**。

# 1. 异常(Exception)

---

**异常** 可能有多种定义以及分类，在此首先讨论的是本书中给出的定义，然后讨论 *riscv ISA* 手册中给出的定义。 

异常是 **由于处理器状态变化，为处理、响应其变化** 所产生的一种异常控制流。

| Class     | Cause                         | Async/sync | Return behavior                     |
| --------- | ----------------------------- | ---------- | ----------------------------------- |
| Interrupt | Signal from I/O device        | Async      | Always returns to next instruction  |
| Trap      | Intentional exception         | Sync       | Always returns to next instruction  |
| Fault     | Potentially recoverable error | Sync       | Might return to current instruction |
| Abort     | Nonrecoverable error          | Sync       | Never returns                       |

## 1.1 trap

---

**陷阱** 的来源可以通过 [文章](https://retrocomputing.stackexchange.com/questions/27043/anyone-know-of-older-mentions-of-the-word-trap-for-software-interrupts-than-th) 去了解。在现代计算机系统中，它指的是一条指令，由程序主动调用。对于 *riscv32* 来说，它有两条陷阱指令 *ecall, ebreak* 。